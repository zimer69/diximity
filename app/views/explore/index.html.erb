<!-- app/views/explore/index.html.erb -->
<div class="container mx-auto px-4 py-6">
  <h1 class="text-3xl font-bold mb-6 text-center">Find Doctors</h1>

  <div class="mb-6 flex justify-center">
    <input
      type="text"
      id="search-input"
      placeholder="Search by name, specialty, or location..."
      class="w-full max-w-xl px-4 py-2 border rounded shadow-sm focus:outline-none focus:ring focus:border-blue-300"
    />
  </div>

  <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 justify-items-center">
    <% @users.each do |user| %>
      <%= link_to user_path(user), class: "block result-card w-64 bg-white border rounded-lg p-4 shadow-md transition-all duration-300 ease-in-out hover:scale-105 hover:shadow-lg" do %>
        <div class="flex items-center gap-4 mb-4">
          <% if user.profile_picture.attached? %>
            <%= image_tag user.profile_picture.variant(resize_to_fill: [64, 64]), class: "w-16 h-16 rounded-full object-cover border" %>
          <% else %>
            <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-sm border">
              No image
            </div>
          <% end %>
          <div>
            <h2 class="text-lg font-semibold text-gray-900"><%= user.name %></h2>
            <p class="text-gray-600 text-sm"><%= user.specialty %></p>
          </div>
        </div>

        <% if user.address %>
          <div class="text-sm text-gray-500">
            <p><%= user.address.city %>, <%= user.address.state %>, <%= user.address.country %></p>
          </div>
        <% end %>
        <p class="text-gray-600 text-sm"><%= user.email %></p>
      <% end %>
    <% end %>
  </div>

  <div id="map" class="mt-10 h-[400px] rounded-lg shadow-md"></div>
</div>

<!-- Filtering Logic -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("search-input");
    const cards = document.querySelectorAll(".result-card");

    input.addEventListener("input", () => {
      const query = input.value.toLowerCase();
      cards.forEach(card => {
        const text = card.innerText.toLowerCase();
        card.classList.toggle("hidden", !text.includes(query));
      });
    });
  });
</script>

<!-- Google Maps -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>

<script>
  function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 4,
      center: { lat: 39.5, lng: -98.35 }, // Center of USA
    });

    const users = <%= raw(
      @users.select { |u| u.address&.latitude && u.address&.longitude }.map do |user|
        {
          lat: user.address.latitude,
          lng: user.address.longitude,
          url: user_path(user),
          name: user.name,
          specialty: user.specialty,
          city: user.address.city,
          state: user.address.state
        }
      end.to_json
    ) %>;

  users.forEach(user => {
    const marker = new google.maps.Marker({
      position: { lat: user.lat, lng: user.lng },
      map: map,
    });

    const infoWindow = new google.maps.InfoWindow({
      content: `
        <div style="font-family: sans-serif; line-height: 1.4;">
          <strong>${user.name}</strong><br/>
          <em>${user.specialty || ''}</em><br/>
          ${user.city && user.state ? `<small>${user.city}, ${user.state}</small><br/>` : ''}
          <a href="${user.url}" style="color: #3b82f6; text-decoration: underline;">View Profile</a>
        </div>
      `
    });

    marker.addListener("click", () => {
      infoWindow.open(map, marker);
    });
  });
  }
</script>
